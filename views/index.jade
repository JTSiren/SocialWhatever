extends layout

block content
  h1 I Can't Believe It's Not Twitter!
  div
    h3 Hello, #{username}. 
    form#post(action="/post", type="POST")
      input#text(type="text" placeholder="What do you have to say?" size="80" maxlength="240")

  ul.allPosts
    each post in allPosts
      div(class="postfield")
        li(class="postlist")
          div
            a.pull-left(href="/user/"+ post.username)= post.username + " "
            p(class="postline")=' said - "' + post.content + '"'
              div(class="time")= 'at ' + post.date
                div
                  button.btn.btn-default(type="submit") Favorite
                  button.btn.btn-default(type="submit") Delete

  script(type='text/javascript').
    $( document ).ready( function(){
      
      var timestamp = Date.now();
      console.log( 'the initial timestamp is: ', timestamp);

      $('#post').submit( function(event){
          event.preventDefault();
          var url = $(this).attr('action');
          var content = { content: $(this).children('input').val() };
          $('#text').val('');
          
          $.post(url, content, function(response){ 
          });
<<<<<<< HEAD
          //console.log( '$(this): ', $(this) );
          //console.log( '$(this) action attribute: ', $(this).attr('action'))
          //console.log( 'the form content: ', content)

          console.log('I wrote this post: ', content );
=======
>>>>>>> c95c7a8b8387004aea3e9a79c9445555ee6c1902
        });

      function refreshPosts () {
        var newposts = []
        $.get( '/refreshPosts' ).done( function( posts ){
            //console.log( 'these are the posts the server sent back: ', posts )
            newposts = posts.map( function( post ){ 
              //console.log( 'this is a post that im mapping over: ', post);
              if ( Date.parse( post.date ) >  timestamp ){
                  console.log( 'timestamp, ', timestamp );
                  console.log( 'post.date, ', post.date );
                  console.log( 'parsed date, ', Date.parse( post.date ) );
                  return post;
                }
            }); //END OF MAP FUNCTION
            newposts=newposts.reverse();
          //console.log('this is newposts after the map function: ', newposts);
          newposts.forEach( function(post) {
            if ( post ){
              $('.allPosts')
                .prepend( 
                  $('<li class="postfield">').html("<a href='/user/" + post.username + "'> "+ post.username + "</a>" + " " +' said - "' + post.content + '"')
                    .append(
                      $('<div class="time">').html('at ' + post.date)
                        .append(
                          $('<div>')
                            .append($('<button class="btn btn-default" type="submit">Favorite</button>'))
                            .append($('<button class="btn btn-default" type="submit">Delete</button>'))
                        )
                    )
                )
            }
          });
          timestamp = Date.now();
          console.log('timestamp is now: ', timestamp);
          }); //END OF DONE CALLBACK
      } //END OF REFRESH FUNCTION
      window.setInterval(refreshPosts, 5000);
    });




